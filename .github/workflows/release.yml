name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.editorconfig'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install MAUI workloads
        run: dotnet workload install maui-windows android ios maccatalyst
      
      - name: Get version
        id: version
        shell: pwsh
        run: |
          $commitCount = git rev-list --count HEAD
          $shortSha = git rev-parse --short HEAD
          $date = Get-Date -Format "yyyy.MM.dd"
          $version = "v$date.$commitCount"
          
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "SHORT_SHA=$shortSha" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
      
      - name: Restore Shared
        run: dotnet restore src/Sidecar.Shared/Sidecar.Shared.csproj
      
      - name: Restore Host
        run: dotnet restore src/Sidecar.Host/Sidecar.Host.csproj
      
      - name: Install Inno Setup
        run: choco install innosetup -y
      
      - name: Build Host
        run: |
          dotnet publish src/Sidecar.Host/Sidecar.Host.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ./publish/host
      
      - name: Build Client
        run: |
          dotnet publish src/Sidecar.Client/Sidecar.Client.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -p:WindowsPackageType=None `
            -o ./publish/client
      
      - name: Create Host Archive
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/host/* -DestinationPath ./Sidecar.Host-win-x64.zip
      
      - name: Build Client Installer
        shell: pwsh
        run: |
          # Update version in setup.iss
          $version = "${{ steps.version.outputs.VERSION }}".TrimStart('v')
          (Get-Content setup.iss) -replace '#define MyAppVersion "1.0.0"', "#define MyAppVersion `"$version`"" | Set-Content setup.iss
          
          # Create installer directory
          New-Item -ItemType Directory -Force -Path installer
          
          # Build installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
      
      - name: Check if tag exists
        id: check_tag
        shell: pwsh
        run: |
          $tagExists = git tag -l "${{ steps.version.outputs.VERSION }}"
          if ($tagExists) {
            echo "TAG_EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "TAG_EXISTS=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Create Release
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Sidecar Release ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¦ Downloads
            
            | ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
            |----------|------|
            | `Sidecar.Client-Setup.exe` | Client ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆè¦–è´å´ï¼‰ |
            | `Sidecar.Host-win-x64.zip` | Host å˜ä½“ï¼ˆé…ä¿¡å´ï¼‰ |
            
            ### ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            
            **Clientï¼ˆè¦–è´å´ï¼‰**: `Sidecar.Client-Setup.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œ
            
            **Hostï¼ˆé…ä¿¡å´ï¼‰**: ZIPã‚’è§£å‡ã—ã¦ `Sidecar.Host.exe` ã‚’å®Ÿè¡Œ
            
            ### ğŸ”§ Changes
            
            Commit: ${{ steps.version.outputs.SHORT_SHA }}
            
            ---
            
            > ğŸ“± **Android/iOS/macOS**: ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚
          files: |
            installer/Sidecar.Client-Setup.exe
            Sidecar.Host-win-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
