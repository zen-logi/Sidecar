name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.editorconfig'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      BUILD_VERSION: ${{ steps.version.outputs.BUILD_VERSION }}
      SHORT_SHA: ${{ steps.version.outputs.SHORT_SHA }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate Version
        id: version
        shell: bash
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          DATE=$(date +'%Y.%m.%d')
          BUILD_VERSION="$DATE.$COMMIT_COUNT"
          RELEASE_TAG="v$BUILD_VERSION"
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Generated Version: $RELEASE_TAG (Build: $BUILD_VERSION)"

  build-windows:
    needs: setup
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ needs.setup.outputs.RELEASE_TAG }}
      BUILD_VERSION: ${{ needs.setup.outputs.BUILD_VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- .NET Build Setup ---
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install MAUI workloads
        run: dotnet workload install maui-windows android ios maccatalyst

      - name: Install Inno Setup
        run: choco install innosetup -y

      # --- Build Host ---
      - name: Restore Host
        run: dotnet restore src/Sidecar.Host/Sidecar.Host.csproj

      - name: Build Host
        run: |
          dotnet publish src/Sidecar.Host/Sidecar.Host.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ./publish/host

      - name: Archive Host
        shell: pwsh
        run: Compress-Archive -Path ./publish/host/* -DestinationPath ./Sidecar.Host-win-x64.zip

      - name: Upload Host Artifact
        uses: actions/upload-artifact@v4
        with:
          name: host-win
          path: Sidecar.Host-win-x64.zip

      # --- Build Client ---
      - name: Restore Client
        run: dotnet restore src/Sidecar.Client/Sidecar.Client.csproj

      - name: Build Client
        run: |
          dotnet publish src/Sidecar.Client/Sidecar.Client.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -p:WindowsPackageType=None `
            -o ./publish/client

      - name: Build Client Installer
        shell: pwsh
        run: |
          $ver = "${{ env.BUILD_VERSION }}"
          (Get-Content setup.iss) -replace '#define MyAppVersion "1.0.0"', "#define MyAppVersion `"$ver`"" | Set-Content setup.iss
          New-Item -ItemType Directory -Force -Path installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

      - name: Upload Client Artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-win
          path: installer/Sidecar.Client-Setup.exe

      # --- Build Electron (Windows) ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare Electron Resources
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path src/Sidecar.MultiSender/resources
          Copy-Item src/Sidecar.Client/Resources/AppIcon/appicon.png src/Sidecar.MultiSender/resources/icon.png

      - name: Build Electron (Windows)
        working-directory: src/Sidecar.MultiSender
        shell: pwsh
        run: |
          npm ci
          npm run build:win

      - name: Upload Electron Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electron-win
          path: src/Sidecar.MultiSender/dist-electron/*.exe

  build-mac:
    needs: setup
    runs-on: macos-latest
    env:
      RELEASE_TAG: ${{ needs.setup.outputs.RELEASE_TAG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare Electron Resources
        run: |
          mkdir -p src/Sidecar.MultiSender/resources
          cp src/Sidecar.Client/Resources/AppIcon/appicon.png src/Sidecar.MultiSender/resources/icon.png

      - name: Build Electron (Mac)
        working-directory: src/Sidecar.MultiSender
        run: |
          npm ci
          npm run build:mac

      - name: Upload Electron Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electron-mac
          path: src/Sidecar.MultiSender/dist-electron/*.dmg

  release:
    needs: [setup, build-windows, build-mac]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display Downloaded Files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.RELEASE_TAG }}
          name: Release ${{ needs.setup.outputs.RELEASE_TAG }}
          body: |
            ## Sidecar Release ${{ needs.setup.outputs.RELEASE_TAG }}
            
            ### üì¶ Downloads
            
            | „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà | „Éï„Ç°„Ç§„É´ | Ë™¨Êòé |
            |--------------|----------|------|
            | **Host** (ÈÖç‰ø°) | `Sidecar.Host-win-x64.zip` | WindowsÁî®„Éõ„Çπ„Éà„Ç¢„Éó„É™ (ZIP) |
            | **Client** (Ë¶ñËÅ¥) | `Sidecar.Client-Setup.exe` | WindowsÁî®„ÇØ„É©„Ç§„Ç¢„É≥„Éà („Ç§„É≥„Çπ„Éà„Éº„É©„Éº) |
            | **Sender** (Mac) | `Sidecar MultiSender-*.dmg` | macOSÁî®„É™„É¨„ÉºÈÄÅ‰ø°„Ç¢„Éó„É™ |
            | **Sender** (Win) | `Sidecar MultiSender Setup *.exe` | WindowsÁî®„É™„É¨„ÉºÈÄÅ‰ø°„Ç¢„Éó„É™ |
            
            ### üì• „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï
            
            - **Host**: Ëß£Âáç„Åó„Å¶ `Sidecar.Host.exe` „ÇíÂÆüË°å
            - **Client**: „Ç§„É≥„Çπ„Éà„Éº„É©„Éº„ÇíÂÆüË°å
            - **Sender**: „Ç§„É≥„Çπ„Éà„Éº„É©„Éº/DMG „ÇíÂÆüË°å
            
            ### üîß Changes
            
            Commit: ${{ needs.setup.outputs.SHORT_SHA }}
          files: |
            artifacts/host-win/*.zip
            artifacts/client-win/*.exe
            artifacts/electron-win/*.exe
            artifacts/electron-mac/*.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
