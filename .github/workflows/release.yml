name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.editorconfig'

permissions:
  contents: write

jobs:
  # =============================================================================
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
  # =============================================================================
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      short_sha: ${{ steps.version.outputs.SHORT_SHA }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          DATE=$(date +"%Y.%m.%d")
          VERSION="v${DATE}.${COMMIT_COUNT}"
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # =============================================================================
  # Windows ãƒ“ãƒ«ãƒ‰ (Host + Client)
  # =============================================================================
  build-windows:
    runs-on: windows-latest
    needs: version
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install MAUI workload
        run: dotnet workload install maui-windows
      
      - name: Restore Host
        run: dotnet restore src/Sidecar.Host/Sidecar.Host.csproj
      
      - name: Restore Client
        run: |
          dotnet restore src/Sidecar.Client/Sidecar.Client.csproj `
            -p:TargetFramework=net10.0-windows10.0.19041.0
      
      - name: Build Host
        run: |
          dotnet publish src/Sidecar.Host/Sidecar.Host.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ./publish/host-win-x64
      
      - name: Build Client
        run: |
          dotnet publish src/Sidecar.Client/Sidecar.Client.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -r win-x64 `
            --no-restore `
            -o ./publish/client-win-x64
      
      - name: Create archives
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/host-win-x64/* -DestinationPath ./Sidecar.Host-win-x64.zip
          Compress-Archive -Path ./publish/client-win-x64/* -DestinationPath ./Sidecar.Client-win-x64.zip
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            Sidecar.Host-win-x64.zip
            Sidecar.Client-win-x64.zip

  # =============================================================================
  # Android ãƒ“ãƒ«ãƒ‰
  # =============================================================================
  build-android:
    runs-on: windows-latest
    needs: version
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install MAUI workload
        run: dotnet workload install maui-android
      
      - name: Restore Shared
        run: dotnet restore src/Sidecar.Shared/Sidecar.Shared.csproj
      
      - name: Restore Client
        run: |
          dotnet restore src/Sidecar.Client/Sidecar.Client.csproj `
            -p:TargetFramework=net10.0-android
      
      - name: Build APK
        run: |
          dotnet publish src/Sidecar.Client/Sidecar.Client.csproj `
            -c Release `
            -f net10.0-android `
            -o ./publish/android
      
      - name: Find and rename APK
        shell: pwsh
        run: |
          $apk = Get-ChildItem -Path ./publish/android -Filter "*.apk" -Recurse | Select-Object -First 1
          if ($apk) {
            Copy-Item $apk.FullName -Destination ./Sidecar.Client-android.apk
          } else {
            Write-Error "APK not found"
            exit 1
          }
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: Sidecar.Client-android.apk

  # =============================================================================
  # macOS / iOS ãƒ“ãƒ«ãƒ‰
  # =============================================================================
  build-apple:
    runs-on: macos-latest
    needs: version
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install MAUI workloads
        run: dotnet workload install maui-maccatalyst maui-ios
      
      - name: Restore Shared
        run: dotnet restore src/Sidecar.Shared/Sidecar.Shared.csproj
      
      # macOS Catalyst ãƒ“ãƒ«ãƒ‰
      - name: Restore (macOS)
        run: |
          dotnet restore src/Sidecar.Client/Sidecar.Client.csproj \
            -p:TargetFramework=net10.0-maccatalyst
      
      - name: Build macOS
        run: |
          dotnet publish src/Sidecar.Client/Sidecar.Client.csproj \
            -c Release \
            -f net10.0-maccatalyst \
            -o ./publish/macos
      
      - name: Create macOS archive
        run: |
          cd ./publish/macos
          zip -r ../../Sidecar.Client-macos.zip .
      
      # iOS ãƒ“ãƒ«ãƒ‰ (ç½²åãªã— - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨)
      - name: Restore (iOS)
        run: |
          dotnet restore src/Sidecar.Client/Sidecar.Client.csproj \
            -p:TargetFramework=net10.0-ios
      
      - name: Build iOS (Simulator)
        run: |
          dotnet build src/Sidecar.Client/Sidecar.Client.csproj \
            -c Release \
            -f net10.0-ios \
            -p:RuntimeIdentifier=iossimulator-arm64 \
            -p:_BundlerDebug=false
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apple-builds
          path: |
            Sidecar.Client-macos.zip

  # =============================================================================
  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  # =============================================================================
  release:
    runs-on: ubuntu-latest
    needs: [version, build-windows, build-android, build-apple]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true
      
      - name: List artifacts
        run: ls -la ./artifacts
      
      - name: Check if tag exists
        id: check_tag
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${{ needs.version.outputs.version }}"; then
            echo "TAG_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "TAG_EXISTS=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: Release ${{ needs.version.outputs.version }}
          body: |
            ## Sidecar Release ${{ needs.version.outputs.version }}
            
            ### ğŸ“¦ Downloads
            
            | Platform | File | Description |
            |----------|------|-------------|
            | ğŸ–¥ï¸ Windows Host | `Sidecar.Host-win-x64.zip` | é…ä¿¡å´ã‚¢ãƒ—ãƒªï¼ˆWindowså°‚ç”¨ï¼‰ |
            | ğŸ–¥ï¸ Windows Client | `Sidecar.Client-win-x64.zip` | è¦–è´å´ã‚¢ãƒ—ãƒª |
            | ğŸ¤– Android | `Sidecar.Client-android.apk` | è¦–è´å´ã‚¢ãƒ—ãƒª |
            | ğŸ macOS | `Sidecar.Client-macos.zip` | è¦–è´å´ã‚¢ãƒ—ãƒª |
            
            ### ğŸ”§ Changes
            
            Commit: ${{ needs.version.outputs.short_sha }}
            
            ---
            
            #### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            
            **Windows**: ZIPã‚’è§£å‡ã—ã¦å®Ÿè¡Œ
            
            **Android**: APKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæä¾›å…ƒä¸æ˜ã®ã‚¢ãƒ—ãƒªã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
            
            **macOS**: ZIPã‚’è§£å‡ã—ã¦Applicationsãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
            
            > âš ï¸ **iOS**: ç½²åã®é–¢ä¿‚ä¸Šã€ç¾åœ¨ã¯ãƒ“ãƒ«ãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚
          files: |
            ./artifacts/Sidecar.Host-win-x64.zip
            ./artifacts/Sidecar.Client-win-x64.zip
            ./artifacts/Sidecar.Client-android.apk
            ./artifacts/Sidecar.Client-macos.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
